# Intentionally not setting a shebang so that shellharden doesn't mess with this file

# Helper to find TTY by walking up the process tree (for Claude Code)
__find_parent_tty() {
  local pid=$$
  local tty=""
  while [[ $pid -gt 1 ]]; do
    tty=$(readlink /proc/$pid/fd/0 2>/dev/null)
    if [[ "$tty" == /dev/pts/* ]]; then
      echo "$tty"
      return 0
    fi
    pid=$(awk '{print $4}' /proc/$pid/stat 2>/dev/null)
  done
  return 1
}

# I added the -w 0 arg to make this work with long input
__wezterm_set_user_var() {
  if hash base64 2>/dev/null ; then
    local output_target=""
    # If inside neovim's terminal, use parent's TTY
    if [[ -n "${NVIM-}" ]] ; then
      output_target=$(readlink /proc/$PPID/fd/0 2>/dev/null)
      [[ -z "$output_target" ]] && return
    # If inside Claude Code, walk up process tree to find TTY
    elif [[ -n "${CLAUDECODE-}" ]] ; then
      output_target=$(__find_parent_tty)
      [[ -z "$output_target" ]] && return
    fi
    if [[ -z "${TMUX-}" ]] ; then
      if [[ -n "$output_target" ]] ; then
        printf "\033]1337;SetUserVar=%s=%s\007" "$1" `echo -n "$2" | base64 -w 0` > "$output_target"
      else
        printf "\033]1337;SetUserVar=%s=%s\007" "$1" `echo -n "$2" | base64 -w 0`
      fi
    else
      # <https://github.com/tmux/tmux/wiki/FAQ#what-is-the-passthrough-escape-sequence-and-how-do-i-use-it>
      # Note that you ALSO need to add "set -g allow-passthrough on" to your tmux.conf
      if [[ -n "$output_target" ]] ; then
        printf "\033Ptmux;\033\033]1337;SetUserVar=%s=%s\007\033\\" "$1" `echo -n "$2" | base64 -w 0` > "$output_target"
      else
        printf "\033Ptmux;\033\033]1337;SetUserVar=%s=%s\007\033\\" "$1" `echo -n "$2" | base64 -w 0`
      fi
    fi
  fi
}
